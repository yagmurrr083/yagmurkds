<!-- Data from Server -->
<script>
    // Force Update: Recreated File
    const pieDataRaw = <% - JSON.stringify((data && data.charts && data.charts.pie) ? data.charts.pie : []) %>;
    const lineDataRaw = <% - JSON.stringify((data && data.charts && data.charts.line) ? data.charts.line : []) %>;
    const barDataRaw = <% - JSON.stringify((data && data.charts && data.charts.bar) ? data.charts.bar : []) %>;
</script>

<script>
    // Currency Formatter
    const currencyFormatter = new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });

    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. Card Logic ---
        const firmaSelect = document.getElementById('firma-select');
        const tahminiGetiriEl = document.getElementById('tahmini-getiri-value');
        const kadinButceEl = document.getElementById('kadin-butce-value');
        const selectedFirmaLabel = document.getElementById('secilen-firma-adi');

        firmaSelect.addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            // Handle Turkish decimal separator (comma) if present, or standard dot
            const rawValue = this.value.toString().replace(/,/g, '.');
            const getiri = parseFloat(rawValue);
            const firmaAd = selectedOption.getAttribute('data-ad');

            if (!isNaN(getiri)) {
                tahminiGetiriEl.textContent = currencyFormatter.format(getiri);
                kadinButceEl.textContent = currencyFormatter.format(getiri * 0.72);
                selectedFirmaLabel.textContent = firmaAd;
            }
        });

        // Trigger generic selection if data exists
        if (firmaSelect.options.length > 1) {
            firmaSelect.selectedIndex = 1;
            firmaSelect.dispatchEvent(new Event('change'));
        }

        // --- 2. Chart Configurations ---

        // Pie Chart
        new Chart(document.getElementById('sustainabilityPieChart'), {
            type: 'doughnut',
            data: {
                labels: pieDataRaw.map(d => d.ad),
                datasets: [{
                    data: pieDataRaw.map(d => d.surdurulebilirlik_uyum_puani),
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });

        // Line Chart
        window.ctxLine = document.getElementById('recyclingLineChart').getContext('2d');
        window.chartLine = new Chart(window.ctxLine, {
            type: 'line',
            data: {
                labels: lineDataRaw.map(d => d.ad),
                datasets: [{
                    label: 'Geri Dönüşüm Oranı (%)',
                    data: lineDataRaw.map(d => d.geri_donusum_orani),
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.3,
                    fill: true,
                    order: 2
                },
                // Reference Line (Recycling)
                {
                    label: 'Hedef Oran',
                    data: Array(lineDataRaw.length).fill(50), // Initial default
                    borderColor: '#e74a3b',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    borderWidth: 2,
                    fill: false,
                    order: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        // Bar Chart (Interactive)
        window.ctxBar = document.getElementById('compatibilityBarChart').getContext('2d');
        window.chartBar = new Chart(window.ctxBar, {
            type: 'bar',
            data: {
                labels: barDataRaw.map(d => d.isletme_adi),
                datasets: [{
                    label: 'Kriter Uyumluluk Puanı',
                    data: barDataRaw.map(d => d.kriter_uyumluluk_puani),
                    backgroundColor: '#4e73df',
                    order: 3,
                    yAxisID: 'y'
                },
                // Reference Lines
                {
                    label: 'Ref: Kadın Çalışan (%)',
                    data: Array(barDataRaw.length).fill(50),
                    type: 'line',
                    borderColor: '#f6c23e',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    order: 1,
                    yAxisID: 'y'
                },
                {
                    label: 'Ref: Engelli Çalışan (%)',
                    data: Array(barDataRaw.length).fill(30),
                    type: 'line',
                    borderColor: '#e74a3b',
                    borderDash: [2, 2],
                    pointRadius: 0,
                    order: 1,
                    yAxisID: 'y'
                },
                {
                    label: 'Ref: Kuruluş Yılı',
                    data: Array(barDataRaw.length).fill(2015),
                    type: 'line',
                    borderColor: '#36b9cc',
                    borderDash: [10, 5],
                    pointRadius: 0,
                    order: 1,
                    yAxisID: 'y1' // Secondary Axis
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Puan / Oran (%)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 2000,
                        max: 2025,
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'Kuruluş Yılı' }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });
    });

    // --- Interactive Updates ---

    // 1. Line Chart Update
    window.updateLineChart = function () {
        const refVal = parseInt(document.getElementById('ref-recycling').value);
        document.getElementById('label-ref-recycling').innerText = refVal + '%';

        // Update Reference Line Data
        window.chartLine.data.datasets[1].data = Array(lineDataRaw.length).fill(refVal);
        window.chartLine.update();
    };

    // 2. Bar Chart Update
    window.updateBarChart = function () {
        const refKadin = parseInt(document.getElementById('ref-kadin').value);
        const refEngelli = parseInt(document.getElementById('ref-engelli').value);
        const refYil = parseInt(document.getElementById('ref-yil').value);

        // Update Labels
        document.getElementById('label-ref-kadin').innerText = refKadin + '%';
        document.getElementById('label-ref-engelli').innerText = refEngelli + '%';
        document.getElementById('label-ref-yil').innerText = refYil;

        // Recalculate Scores
        const newData = barDataRaw.map(item => {
            let baseScore = parseFloat(item.kriter_uyumluluk_puani);

            const kadinDiff = (item.kadin_calisan_orani || 0) - refKadin;
            baseScore += (kadinDiff / 2);

            const engelliDiff = (item.engelli_calisan_orani || 0) - refEngelli;
            baseScore += (engelliDiff * 5);

            const yilDiff = (item.kurulus_yili || 2000) - refYil;
            baseScore += (yilDiff / 2);

            return Math.min(100, Math.max(0, Math.round(baseScore)));
        });

        // Update Main Data
        window.chartBar.data.datasets[0].data = newData;

        // Update Reference Lines
        window.chartBar.data.datasets[1].data = Array(barDataRaw.length).fill(refKadin);
        window.chartBar.data.datasets[2].data = Array(barDataRaw.length).fill(refEngelli);
        window.chartBar.data.datasets[3].data = Array(barDataRaw.length).fill(refYil);

        window.chartBar.update();
    };
</script>